<!--
    @license
    Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
    This code may only be used under the BSD style license found at https://polymer.github.io/LICENSE.txt
    The complete set of authors may be found at https://polymer.github.io/AUTHORS.txt
    The complete set of contributors may be found at https://polymer.github.io/CONTRIBUTORS.txt
    Code distributed by Google as part of the polymer project is also
    subject to an additional IP rights grant found at https://polymer.github.io/PATENTS.txt
-->
<!doctype html>
<html>
<head>
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
  <script src="../../web-component-tester/browser.js"></script>

  <link rel="import" href="../../promise-polyfill/promise-polyfill-lite.html">
  <link rel="import" href="../google-chart.html">
</head>

<body>

<style>
  google-chart {
    height: 300px;
    width: 500px;
  }
</style>
<test-fixture id="chart-fixture">
  <template>
    <google-chart id="chart"></google-chart>
  </template>
</test-fixture>

<script>
suite('<google-chart>', () => {
  let chart;

  setup(() => {
    chart = fixture('chart-fixture');
  });

  test('is not initially drawn', () => {
    assert.isFalse(chart.drawn);
    assert.equal(chart.$$('#chart').innerText, 'Loading chart...');
    assert.lengthOf(chart.actions, 0);
    assert.lengthOf(chart.events, 0);
    assert.lengthOf(chart.selection, 0);
    assert.deepEqual(chart.options, {});
    assert.isNotOk(chart.view);
    assert.isNotOk(chart.error);
    assert.isNotOk(chart.query);
    assert.isNotOk(chart.src);
    assert.isNotOk(chart.data);
    assert.isOk(chart.wrapper);
  });

  suite('Simple Functionality', () => {
    setup(() => {
      chart.data = [ ['Data', 'Value'], ['Something', 1] ];
    });

    suite('fires `google-chart-ready` event', () => {
      test('on initial draw', done => {
        chart.addEventListener('google-chart-ready', () => {
          assert.isTrue(chart.drawn);
          done();
        });
      });

      test('once for each redraw', done => {
        let drawCount = 0;
        chart.addEventListener('google-chart-ready', () => {
          assert.isTrue(chart.drawn);
          ++drawCount;
          if (drawCount == 4) {
            done();
          } else {
            chart.draw();
          }
        });
      });
    });

    suite('type', () => {
      test('default is `column`', () => {
        assert.equal(chart.type, 'column');
      });

      test('can be changed', done => {
        chart.type = 'line';
        chart.addEventListener('google-chart-ready', () => {
          // A circle indicates the chart type change was drawn:
          assert.isOk(chart.$$('circle'));
          done();
        });
      });
    });

    suite('selection', () => {
      test('default has no rows', () => {
        assert.lengthOf(chart.selection, 0);
      });

      test('can be changed', done => {
        chart.selection = [ {row: 0} ];
        chart.addEventListener('google-chart-ready', () => {
          // A white stroked rectangle signals the selection was drawn:
          assert.isOk(chart.$$('rect[stroke="#ffffff"]'));
          done();
        });
      });
    });

    suite('options', () => {
      test('default is an empty Object', () => {
        assert.deepEqual(chart.options, {});
      });

      test('can be changed', done => {
        var expectedTitle = 'New Title';
        var initialDraw = true;
        chart.addEventListener('google-chart-ready', () => {
          if (initialDraw) {
            initialDraw = false;
            chart.options = {'title': expectedTitle};
          } else {
            //debugger
            assert.equal(chart.$$('text').innerHTML, expectedTitle);
            done();
          }
        });
      });

      test('can have subproperties changed', done => {
        chart.options = {'title': 'Old Title'};
        const expectedTitle = 'New Title';

        let initialDraw = true;
        chart.addEventListener('google-chart-ready', () => {
          if (initialDraw) {
            initialDraw = false;
            assert.equal(chart.options.title, 'Old Title');
            chart.set('options.title', 'Debounced Title');
            chart.set('options.title', expectedTitle);
          } else {
            assert.equal(chart.$$('text').innerHTML, expectedTitle);
            done();
          }
        });
      });
    });

    test('creates png chart uri', done => {
      chart.addEventListener('google-chart-ready', () => {
        const uri = chart.imageURI;
        assert.isString(uri);
        assert.match(uri, /^data:image\/png;base64/, 'png regexp matches');
        done();
      });
    });

    test('can render multiple instances', done => {
      const secondChart = fixture('chart-fixture');
      secondChart.data = [ ['Data', 'Value'], ['Something', 1] ];

      // Ensure second chart is rendered. Clean up test.
      secondChart.addEventListener('google-chart-ready', () => {
        done();
      });
    });
  });
});
</script>

</body>
</html>
